## 8.2 大语言模型安全架构模式

本节介绍经过验证的 LLM 安全架构模式，为系统设计提供参考。

### 8.2.1 网关模式

所有与 LLM 的交互都经过安全网关，实现集中的安全控制。

**架构图**：

```mermaid
flowchart TB
    subgraph "客户端"
    A["应用/用户"]
    end
    
    subgraph "安全网关"
    B["认证授权"]
    C["输入检查"]
    D["速率限制"]
    E["日志审计"]
    end
    
    subgraph "LLM 后端"
    F["LLM 引擎"]
    G["工具服务"]
    end
    
    A --> B --> C --> D --> E --> F
    F <--> G
```

图 8-1：网关模式架构图

**优势**：

| 优势 | 描述 |
|------|------|
| 集中控制 | 统一的安全策略管理 |
| 简化运维 | 安全组件独立部署 |
| 易于扩展 | 可添加新的安全组件 |
| 完整日志 | 所有请求都有记录 |

**适用场景**：

- API 服务形式提供 LLM 能力
- 多个应用共享 LLM 服务
- 需要统一的安全策略

### 8.2.2 三明治模式

在输入和输出两端都部署安全层，形成"三明治"结构。

**架构图**：

```mermaid
flowchart LR
    subgraph "输入侧"
    A["输入过滤器"]
    B["注入检测"]
    C["上下文构建"]
    end
    
    subgraph "核心"
    D["LLM"]
    end
    
    subgraph "输出侧"
    E["内容审核"]
    F["敏感过滤"]
    G["格式验证"]
    end
    
    A --> B --> C --> D --> E --> F --> G
```

图 8-2：三明治模式架构图

**设计要点**：

```
输入侧：
- 验证输入格式和长度
- 检测恶意注入
- 规范化和清洗输入
- 构建安全的上下文

输出侧：
- 检查有害内容
- 过滤敏感信息
- 验证输出格式
- 添加安全标记
```

### 8.2.3 代理模式

在用户和 LLM 之间引入代理层，处理所有直接交互。

**架构图**：

```mermaid
flowchart TB
    A["用户"] <--> B["AI 代理层"]
    B <--> C["LLM"]
    B <--> D["工具/服务"]
    B <--> E["知识库"]
    
    subgraph "代理层功能"
    F["请求路由"]
    G["权限控制"]
    H["安全检查"]
    I["结果过滤"]
    end
    
    B -.-> F
    B -.-> G
    B -.-> H
    B -.-> I
```

图 8-3：代理模式架构图

**优势**：

- 解耦用户与 LLM 的直接交互
- 可以实现复杂的业务逻辑
- 支持多 LLM 后端
- 便于实施精细权限控制

### 8.2.4 隔离模式

将高风险操作隔离到独立的安全域中执行。

**架构图**：

```mermaid
flowchart TB
    subgraph "可信域"
    A["用户接口"]
    B["业务逻辑"]
    end
    
    subgraph "隔离域"
    C["LLM 沙箱"]
    D["代码执行沙箱"]
    E["工具沙箱"]
    end
    
    subgraph "数据域"
    F["数据存储"]
    end
    
    A --> B
    B <--> |受限接口| C
    B <--> |受限接口| D
    B <--> |受限接口| E
    B <--> F
```

图 8-4：隔离模式架构图

**隔离机制**：

| 隔离类型 | 描述 |
|----------|------|
| 进程隔离 | 独立进程运行 |
| 容器隔离 | Docker/K8s 容器 |
| 网络隔离 | 限制网络访问 |
| 资源隔离 | 限制 CPU/内存 |

### 8.2.5 零信任模式

采用零信任原则，不预设信任任何组件。

**核心原则**：

```mermaid
mindmap
  root((零信任 LLM))
    持续验证
      每次请求验证
      会话状态检查
    最小权限
      按需授权
      时间限制
    假设泄露
      加密传输
      敏感数据保护
    微分段
      服务隔离
      访问控制
```

图 8-5：零信任模式思维导图

**实施要点**：

```
1. 持续验证身份
- 不依赖网络位置
- 每次调用都验证

2. 最小权限原则
- 仅授予必要权限
- 权限按需临时授予

3. 假设已被入侵
- 加密所有敏感数据
- 限制数据访问范围

4. 细粒度访问控制
- 基于属性的访问控制
- 实时策略评估
```

### 8.2.6 多模型检查模式

使用多个模型相互验证，提高安全性。

**架构图**：

```mermaid
flowchart TB
    A["用户输入"] --> B["主 LLM"]
    A --> C["安全检查 LLM"]
    
    B --> D["输出"]
    C --> E{"安全判定"}
    
    E --> |安全| F["返回输出"]
    E --> |不安全| G["拒绝/修改"]
    
    D --> F
```

图 8-6：多模型检查模式架构图

**应用示例**：

- 使用独立 LLM 检查输入是否安全
- 使用独立 LLM 验证输出是否合规
- 多个 LLM 投票决定行动

### 8.2.7 架构选型建议

根据场景选择合适的架构模式：

| 场景 | 推荐模式 |
|------|----------|
| API 服务 | 网关模式 |
| 通用应用 | 三明治模式 |
| 复杂系统 | 代理模式 |
| 高安全需求 | 隔离模式 + 零信任 |
| 内容审核严格 | 多模型检查模式 |

实际系统通常需要组合多种模式。
